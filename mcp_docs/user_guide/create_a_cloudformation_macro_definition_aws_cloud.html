<!-- Source URL: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros-author.html -->
<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Create a CloudFormation macro definition - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="template-macros-author" /><meta name="default_state" content="template-macros-author" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros-author.html" /><meta name="description" content="Learn how to create a CloudFormation macro definition." /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="User Guide" /><meta name="abstract" content="Create and manage AWS infrastructure deployments predictably and repeatedly using AWS CloudFormation with this User Guide." /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros-author.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros-author.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="User Guide" /><head xmlns="http://www.w3.org/1999/xhtml"> <script defer="" src="/assets/r/awsdocs-doc-page.2.0.0.js"></script><link href="/assets/r/awsdocs-doc-page.2.0.0.css" rel="stylesheet"/></head>
<script defer="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="User Guide" /><meta id="panorama-serviceConsolePage" value="Create a CloudFormation macro definition" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Create a CloudFormation macro definition - AWS CloudFormation</title><meta name="pdf" content="/pdfs/AWSCloudFormation/latest/UserGuide/cfn-ug.pdf#template-macros-author" /><meta name="rss" content="aws-cloudformation-user-guide-updates.rss" /><meta name="forums" content="https://repost.aws/tags/TAm3R3LNU3RfSX9L23YIpo3w" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/template-macros-author.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/template-macros-author.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/template-macros-author.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,resource provisioning,resource configuration,infrastructure management,CloudFormer,CloudFormation stack,CloudFormation stackset,CloudFormation template,change set,CloudFormation templates,define your infrastructure" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "User Guide",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Working with CloudFormation templates",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Extend your template's capabilities with CloudFormation-supplied resource types",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cloudformation-supplied-resource-types.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "Perform custom processing on CloudFormation templates with template macros",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros.html"
      },
      {
        "@type" : "ListItem",
        "position" : 7,
        "name" : "Create a CloudFormation macro definition",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-macros.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"><a href="/pdfs/AWSCloudFormation/latest/UserGuide/cfn-ug.pdf#template-macros-author" target="_blank" rel="noopener noreferrer" title="Open PDF"></a></div><div id="breadcrumbs" class="breadcrumb"><a href="/index.html">Documentation</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">User Guide</a></div><div id="page-toc-src"><a href="#template-macros-event-mapping">Event mapping</a><a href="#template-macros-response-format">Response format</a><a href="#create-a-macro-definition">Create a macro definition</a><a href="#template-macros-scope">Macro template scope</a><a href="#template-macros-order">Macro evaluation order</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="template-macros-author">Create a CloudFormation macro definition</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>When you create a macro definition, the macro definition makes the underlying Lambda
            function available in the specified account so that CloudFormation invokes it to process the
            templates.</p>
            <h2 id="template-macros-event-mapping">Event mapping</h2>
            <p>When CloudFormation invokes a macro's Lambda function, it sends a request in JSON
                format with the following structure:</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
    "region" : "<code class="replaceable">us-east-1</code>",
    "accountId" : "<code class="replaceable">$ACCOUNT_ID</code>",
    "fragment" : <span>{</span> <code class="replaceable">...</code> },
    "transformId" : "<code class="replaceable">$TRANSFORM_ID</code>",
    "params" : <span>{</span> <code class="replaceable">...</code> },
    "requestId" : "<code class="replaceable">$REQUEST_ID</code>",
    "templateParameterValues" : <span>{</span> <code class="replaceable">...</code> }
}</code></pre>
            <div class="itemizedlist">
                 
                 
                 
                 
                 
                 
                 
            <ul class="itemizedlist"><li class="listitem">
                    <p><code class="code">region</code></p>
                    <p>The Region in which the macro resides.</p>
                </li><li class="listitem">
                    <p><code class="code">accountId</code></p>
                    <p>The account ID of the account from which the macro is invoking the Lambda
                        function.</p>
                </li><li class="listitem">
                    <p><code class="code">fragment</code></p>
                    <p>The template content available for custom processing, in JSON
                        format.</p>
                    <div class="itemizedlist">
                         
                         
                    <ul class="itemizedlist"><li class="listitem">
                            <p>For macros included in the <code class="code">Transform</code> template
                                section, this is the entire template except for the
                                    <code class="code">Transform</code> section.</p>
                        </li><li class="listitem">
                            <p>For macros included in an <code class="code">Fn::Transform</code> intrinsic
                                function call, this includes all sibling nodes (and their children)
                                based on the location of the intrinsic function within the template
                                except for the <code class="code">Fn::Transform</code> function. For more
                                information, see <a href="#template-macros-scope">Macro template scope</a>.</p>
                        </li></ul></div>
                </li><li class="listitem">
                    <p><code class="code">transformId</code></p>
                    <p>The name of the macro invoking this function.</p>
                </li><li class="listitem">
                    <p><code class="code">params</code></p>
                    <p>For <code class="code">Fn::Transform</code> function calls, any specified parameters
                        for the function. CloudFormation doesn't evaluate these parameters before
                        passing them to the function.</p>
                    <p>For macros included in the <code class="code">Transform</code> template section, this
                        section is empty.</p>
                </li><li class="listitem">
                    <p><code class="code">requestId</code></p>
                    <p>The ID of the request invoking this function.</p>
                </li><li class="listitem">
                    <p><code class="code">templateParameterValues</code></p>
                    <p>Any parameters specified in the <a href="./parameters-section-structure.html">Parameters</a> section of the
                        template. CloudFormation evaluates these parameters before passing them to the
                        function.</p>
                </li></ul></div>
         
            <h2 id="template-macros-response-format">Response format</h2>
            <p>CloudFormation expects the Lambda function to return a response in the following JSON
                format:</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
    "requestId" : "<code class="replaceable">$REQUEST_ID</code>",
    "status" : "<code class="replaceable">$STATUS</code>",
    "fragment" : <span>{</span> <code class="replaceable">...</code> },
    "errorMessage": "optional error message for failures"
}</code></pre>
            <div class="itemizedlist">
                 
                 
                 
                 
            <ul class="itemizedlist"><li class="listitem">
                    <p><code class="code">requestId</code></p>
                    <p>The ID of the request invoking this function. This must match the request
                        ID provided by CloudFormation when invoking the function.</p>
                </li><li class="listitem">
                    <p><code class="code">status</code></p>
                    <p>The status of the request (case-insensitive). Should be set to
                            <code class="code">success</code>. CloudFormation treats any other response as a
                        failure.</p>
                </li><li class="listitem">
                    <p><code class="code">fragment</code></p>
                    <p>The processed template content for CloudFormation to include in the processed
                        template, including siblings. CloudFormation replaces the template content that
                        is passed to the Lambda function with the template fragment it receives in
                        the Lambda response.</p>
                    <p>The processed template content must be valid JSON, and its inclusion in
                        the processed template must result in a valid template.</p>
                    <p>If your function doesn't actually change the template content that
                        CloudFormation passes to it, but you still need to include that content in the
                        processed template, your function needs to return that template content to
                        CloudFormation in its response.</p>
                </li><li class="listitem">
                    <p><code class="code">errorMessage</code></p>
                    <p>The error message that explains why the transform failed. CloudFormation
                        displays this error message in the <b>Events</b> pane of the
                            <b>Stack details</b> page for your stack.</p>
                    <p>For example:</p>
                    <pre class="screen">Error creating change set: Transform
                            <code class="replaceable">AWS account account
                            number</code>::<code class="replaceable">macro name</code> failed with:
                            <code class="replaceable">error message string</code>.</pre>
                </li></ul></div>
         
            <h2 id="create-a-macro-definition">Create a macro definition</h2>
            <div class="procedure"><h6>To create a CloudFormation macro
                    definition</h6><ol><li>
                    <p><a href="https://docs.aws.amazon.com/lambda/latest/dg/getting-started.html">Build a Lambda function</a> that will handle the processing of
                        template contents. It can process any part of a template, up to the entire
                        template. </p>
                </li><li>
                    <p>Create a CloudFormation template containing an
                            <code class="code">AWS::CloudFormation::Macro</code> resource type and specify the
                            <code class="code">Name</code> and <code class="code">FunctionName</code> properties. The
                            <code class="code">FunctionName</code> property must contain the ARN of the Lambda
                        function to invoke when CloudFormation runs the macro.</p>
                </li><li>
                    <p>(Optional) To aid in debugging, you can also specify the
                            <code class="code">LogGroupName</code> and <code class="code">LogRoleArn</code> properties when
                        creating the <code class="code">AWS::CloudFormation::Macro</code> resource type for your
                        macro. These properties enable you to specify the CloudWatch Logs log group to which
                        CloudFormation sends error logging information when invoking the macro's
                        underlying Lambda function, and the role CloudFormation should assume when
                        sending log entries to those logs.</p>
                </li><li>
                    <p><a href="./cfn-console-create-stack.html">Create a stack</a> using the
                        template with the macro in the account you want to use it in. Or, <a href="./stacksets-getting-started-create-self-managed.html">create a stack
                            set with self-managed permissions</a> using the template with the
                        macro in the administrator account, and then create stack instances in the
                        target accounts.</p>
                </li><li>
                    <p>After CloudFormation has successfully created the stacks that contain the
                        macro definition, the macro is available for use within those accounts. You
                        use a macro by referencing it in a template, at the appropriate location
                        relevant to the template contents you want to process.</p>
                </li></ol></div>
         
            <h2 id="template-macros-scope">Macro template scope</h2>
            <p>Macros referenced in the <code class="code">Transform</code> section of a template can process
                the entire contents of that template.</p>
            <p>Macros referenced in an <code class="code">Fn::Transform</code> function can process the
                contents of any of the sibling elements (including children) of that
                    <code class="code">Fn::Transform</code> function in the template.</p>
            <p>For example, in the template sample below, <code class="code">AWS::Include</code> can process
                the <code class="code">MyBucket</code> properties, based on the location of the
                    <code class="code">Fn::Transform</code> function that contains it. <code class="code">MyMacro</code> can
                process the contents of the entire template because of its inclusion in the
                    <code class="code">Transform</code> section.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (yaml)--><code class="yaml "># Start of processable content for MyMacro
AWSTemplateFormatVersion: 2010-09-09 
 Transform: [MyMacro]
 Resources:
    WaitCondition:
      Type: AWS::CloudFormation::WaitCondition
    MyBucket:
      Type: AWS::S3::Bucket
      # Start of processable content for AWS::Include
      Properties:
        BucketName: <code class="replaceable">amzn-s3-demo-bucket1</code>
        Tags: <code class="replaceable">[<span>{</span>"key":"value"}]</code> 
        'Fn::Transform':
          - Name: 'AWS::Include'
              Parameters:
                Location: <code class="replaceable">s3://amzn-s3-demo-bucket2/MyFileName.yaml</code>
        CorsConfiguration: <code class="replaceable">[]</code>
        # End of processable content for AWS::Include
    MyEc2Instance:
      Type: AWS::EC2::Instance
      Properties:
        ImageID: <code class="replaceable">ami-1234567890abcdef0</code>
# End of processable content for MyMacro</code></pre>
         
            <h2 id="template-macros-order">Macro evaluation order</h2>
            <p>You can reference multiple macros in a given template, including transforms hosted
                by CloudFormation, such as <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/TemplateReference/transform-aws-include.html">AWS::Include</a> and <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/TemplateReference/transform-aws-serverless.html">AWS::Serverless</a>.</p>
            <p>Macros are evaluated in order, based on their location in the template, from the
                most deeply nested outward to the most general. Macros at the same location in the
                template are evaluated serially based on the order in which they're listed.</p>
            <p>Transforms such as <code class="code">AWS::Include</code> and <code class="code">AWS::Transform</code> are
                treated the same as any other macros in terms of action order and scope.</p>
            <p>For example, in the template sample below, CloudFormation evaluates the
                    <code class="code">PolicyAdder</code> macro first, because it's the most deeply-nested macro
                in the template. CloudFormation then evaluates <code class="code">MyMacro</code> before evaluating
                    <code class="code">AWS::Serverless</code> because it's listed before
                    <code class="code">AWS::Serverless</code> in the <code class="code">Transform</code> section.</p>
            <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (yaml)--><code class="yaml ">AWSTemplateFormatVersion: 2010-09-09
 Transform: [MyMacro, AWS::Serverless]
 Resources:
    WaitCondition:
      Type: AWS::CloudFormation::WaitCondition
    MyBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: <code class="replaceable">amzn-s3-demo-bucket</code>
        Tags: <code class="replaceable">[<span>{</span>"key":"value"}]</code>
        'Fn::Transform':
          - Name: PolicyAdder
        CorsConfiguration: <code class="replaceable">[]</code>
    MyEc2Instance:
      Type: AWS::EC2::Instance
      Properties:
        ImageID: <code class="replaceable">ami-1234567890abcdef0</code></code></pre>
        <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./template-macros-overview.html">Macros overview</div><div id="next" class="next-link" accesskey="n" href="./macros-example.html">Example simple string replacement
                macro</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/template-macros-author.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/template-macros-author.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>