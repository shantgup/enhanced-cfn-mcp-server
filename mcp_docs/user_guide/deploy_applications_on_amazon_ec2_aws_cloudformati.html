<!-- Source URL: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/deploying.applications.html -->
<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Deploy applications on Amazon EC2 - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="deploying.applications" /><meta name="default_state" content="deploying.applications" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/deploying.applications.html" /><meta name="description" content="Automatically install, configure, and start up your application on Amazon EC2 with CloudFormation." /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="User Guide" /><meta name="abstract" content="Create and manage AWS infrastructure deployments predictably and repeatedly using AWS CloudFormation with this User Guide." /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/deploying.applications.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/deploying.applications.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="User Guide" /><head xmlns="http://www.w3.org/1999/xhtml"> <script defer="" src="/assets/r/awsdocs-doc-page.2.0.0.js"></script><link href="/assets/r/awsdocs-doc-page.2.0.0.css" rel="stylesheet"/></head>
<script defer="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="User Guide" /><meta id="panorama-serviceConsolePage" value="Deploy applications on Amazon EC2" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Deploy applications on Amazon EC2 - AWS CloudFormation</title><meta name="pdf" content="/pdfs/AWSCloudFormation/latest/UserGuide/cfn-ug.pdf#deploying.applications" /><meta name="rss" content="aws-cloudformation-user-guide-updates.rss" /><meta name="forums" content="https://repost.aws/tags/TAm3R3LNU3RfSX9L23YIpo3w" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/deploying.applications.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/deploying.applications.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/deploying.applications.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,resource provisioning,resource configuration,infrastructure management,CloudFormer,CloudFormation stack,CloudFormation stackset,CloudFormation template,change set,CloudFormation templates,define your infrastructure" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "User Guide",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Working with CloudFormation templates",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "CloudFormation walkthroughs",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthroughs.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "Deploy applications on Amazon EC2",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/walkthroughs.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"><a href="/pdfs/AWSCloudFormation/latest/UserGuide/cfn-ug.pdf#deploying.applications" target="_blank" rel="noopener noreferrer" title="Open PDF"></a></div><div id="breadcrumbs" class="breadcrumb"><a href="/index.html">Documentation</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">User Guide</a></div><div id="page-toc-src"><a href="#deployment-walkthrough-basic-server">Step 1: Create a base template</a><a href="#deployment-walkthrough-lamp-install">Step 2: Add helper script for the LAMP
        installation</a><a href="#deployment-walkthrough-config">Step 3: Expand the scripts to configure
        Apache, MySQL, and PHP</a><a href="#deployment-walkthrough-cfn-signal">Step 4: Add the creation policy and signal
        configuration</a><a href="#deployment-walkthrough-related-resources">Related resources</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="deploying.applications">Deploy applications on Amazon EC2</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>You can use CloudFormation to automatically install, configure, and start applications on Amazon EC2
    instances. Doing so enables you to easily duplicate deployments and update existing
    installations without connecting directly to the instance, which can save you a lot of time and
    effort.</p><p>CloudFormation includes a set of helper scripts (<code class="code">cfn-init</code>, <code class="code">cfn-signal</code>,
      <code class="code">cfn-get-metadata</code>, and <code class="code">cfn-hup</code>) that are based on
      <code class="code">cloud-init</code>. You call these helper scripts from your CloudFormation templates to
    install, configure, and update applications on Amazon EC2 instances that are in the same template.
    For more information, see the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/TemplateReference/cfn-helper-scripts-reference.html">CloudFormation helper scripts reference</a>
    in the <em>AWS CloudFormation Template Reference Guide</em>.</p><p>The following walkthrough describes how to create a template that launches a LAMP stack by
    using helper scripts to install, configure, and start Apache, MySQL, and PHP. You'll start with
    a simple template that sets up a basic Amazon EC2 instance running Amazon Linux, and then continue adding to
    the template until it describes a full LAMP stack.</p><p>The examples provided are based on an older version of Amazon Linux. You will be unable to boot
    instances launched from these templates until you update the AMIs to use your desired version of
    Amazon Linux and then update the helper scripts to support that version. For information about
    installing a LAMP stack on AL2023, see <a href="https://docs.aws.amazon.com/linux/al2023/ug/ec2-lamp-amazon-linux-2023.html">Tutorial: Install a LAMP server on
      AL2023</a> in the <em>AL2023 User Guide</em>. </p><div class="highlights" id="inline-topiclist"><h6>Topics</h6><ul><li><p><a href="#deployment-walkthrough-basic-server">Step 1: Create a base template</a></p></li><li><p><a href="#deployment-walkthrough-lamp-install">Step 2: Add helper script for the LAMP
        installation</a></p></li><li><p><a href="#deployment-walkthrough-config">Step 3: Expand the scripts to configure
        Apache, MySQL, and PHP</a></p></li><li><p><a href="#deployment-walkthrough-cfn-signal">Step 4: Add the creation policy and signal
        configuration</a></p></li><li><p><a href="#deployment-walkthrough-related-resources">Related resources</a></p></li></ul></div><div class="awsdocs-note"><div class="awsdocs-note-title"><awsui-icon name="status-info" variant="link"></awsui-icon><h6>Note</h6></div><div class="awsdocs-note-text"><p>Consider AWS Systems Manager parameters as an alternative to the <code class="code">Mappings</code> section. To avoid
        updating all your templates with a new ID each time the AMI that you want to use changes,
        use the <code class="code">AWS::SSM::Parameter::Value&lt;AWS::EC2::Image::Id&gt;</code> parameter type to
        retrieve the latest AMI ID when the stack is created or updated. The latest versions of
        commonly used AMIs are also available as public parameters in Systems Manager. For more information, see <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cloudformation-supplied-parameter-types.html">Specify existing resources at runtime</a>. </p></div></div>
    <h2 id="deployment-walkthrough-basic-server">Step 1: Create a base template</h2>
    <p>You start with a basic template that defines a single Amazon EC2 instance with a security group
      that allows SSH traffic on port 22 and HTTP traffic on port 80, as shown in the following
      example.</p>
    <p>In addition to the Amazon EC2 instance and security group, we create three input parameters
      that specify the instance type, an Amazon EC2 key pair to use for SSH access, and an IP address
      range that can be used to SSH to the instance. The mapping section ensures that CloudFormation
      uses the correct AMI ID for the stack's region and the Amazon EC2 instance type. Finally, the
      output section outputs the public URL of the web server.</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (yaml)--><code class="yaml ">AWSTemplateFormatVersion: 2010-09-09
Description: &gt;-
  AWS CloudFormation sample template LAMP_Single_Instance: Create a LAMP stack
  using a single EC2 instance and a local MySQL database for storage. This
  template demonstrates using the AWS CloudFormation bootstrap scripts to
  install the packages and files necessary to deploy the Apache web server, PHP,
  and MySQL at instance launch time. **WARNING** This template creates an Amazon
  EC2 instance. You will be billed for the AWS resources used if you create a
  stack from this template.
Parameters:
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: Can contain only ASCII characters.
  InstanceType:
    Description: WebServer EC2 instance type
    Type: String
    Default: t2.small
    AllowedValues:
      - t1.micro
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - m1.small
      - m1.medium
      - m1.large
      - m1.xlarge
      - m2.xlarge
      - m2.2xlarge
      - m2.4xlarge
      - m3.medium
      - m3.large
      - m3.xlarge
      - m3.2xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.10xlarge
      - c1.medium
      - c1.xlarge
      - c3.large
      - c3.xlarge
      - c3.2xlarge
      - c3.4xlarge
      - c3.8xlarge
      - c4.large
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c4.8xlarge
      - g2.2xlarge
      - g2.8xlarge
      - r3.large
      - r3.xlarge
      - r3.2xlarge
      - r3.4xlarge
      - r3.8xlarge
      - i2.xlarge
      - i2.2xlarge
      - i2.4xlarge
      - i2.8xlarge
      - d2.xlarge
      - d2.2xlarge
      - d2.4xlarge
      - d2.8xlarge
      - hi1.4xlarge
      - hs1.8xlarge
      - cr1.8xlarge
      - cc2.8xlarge
      - cg1.4xlarge
    ConstraintDescription: must be a valid EC2 instance type.
  SSHLocation:
    Description: The IP address range that can be used to SSH to the EC2 instances
    Type: String
    MinLength: '9'
    MaxLength: '18'
    Default: 0.0.0.0/0
    AllowedPattern: '(\d<span>{</span>1,3})\.(\d<span>{</span>1,3})\.(\d<span>{</span>1,3})\.(\d<span>{</span>1,3})/(\d<span>{</span>1,2})'
    ConstraintDescription: Must be a valid IP CIDR range of the form x.x.x.x/x
Mappings:
  AWSInstanceType2Arch:
    t1.micro:
      Arch: HVM64
    t2.nano:
      Arch: HVM64
    t2.micro:
      Arch: HVM64
    t2.small:
      Arch: HVM64
    t2.medium:
      Arch: HVM64
    t2.large:
      Arch: HVM64
    m1.small:
      Arch: HVM64
    m1.medium:
      Arch: HVM64
    m1.large:
      Arch: HVM64
    m1.xlarge:
      Arch: HVM64
    m2.xlarge:
      Arch: HVM64
    m2.2xlarge:
      Arch: HVM64
    m2.4xlarge:
      Arch: HVM64
    m3.medium:
      Arch: HVM64
    m3.large:
      Arch: HVM64
    m3.xlarge:
      Arch: HVM64
    m3.2xlarge:
      Arch: HVM64
    m4.large:
      Arch: HVM64
    m4.xlarge:
      Arch: HVM64
    m4.2xlarge:
      Arch: HVM64
    m4.4xlarge:
      Arch: HVM64
    m4.10xlarge:
      Arch: HVM64
    c1.medium:
      Arch: HVM64
    c1.xlarge:
      Arch: HVM64
    c3.large:
      Arch: HVM64
    c3.xlarge:
      Arch: HVM64
    c3.2xlarge:
      Arch: HVM64
    c3.4xlarge:
      Arch: HVM64
    c3.8xlarge:
      Arch: HVM64
    c4.large:
      Arch: HVM64
    c4.xlarge:
      Arch: HVM64
    c4.2xlarge:
      Arch: HVM64
    c4.4xlarge:
      Arch: HVM64
    c4.8xlarge:
      Arch: HVM64
    g2.2xlarge:
      Arch: HVMG2
    g2.8xlarge:
      Arch: HVMG2
    r3.large:
      Arch: HVM64
    r3.xlarge:
      Arch: HVM64
    r3.2xlarge:
      Arch: HVM64
    r3.4xlarge:
      Arch: HVM64
    r3.8xlarge:
      Arch: HVM64
    i2.xlarge:
      Arch: HVM64
    i2.2xlarge:
      Arch: HVM64
    i2.4xlarge:
      Arch: HVM64
    i2.8xlarge:
      Arch: HVM64
    d2.xlarge:
      Arch: HVM64
    d2.2xlarge:
      Arch: HVM64
    d2.4xlarge:
      Arch: HVM64
    d2.8xlarge:
      Arch: HVM64
    hi1.4xlarge:
      Arch: HVM64
    hs1.8xlarge:
      Arch: HVM64
    cr1.8xlarge:
      Arch: HVM64
    cc2.8xlarge:
      Arch: HVM64
  AWSRegionArch2AMI:
    us-east-1:
      HVM64: ami-0ff8a91507f77f867
      HVMG2: ami-0a584ac55a7631c0c
    us-west-2:
      HVM64: ami-a0cfeed8
      HVMG2: ami-0e09505bc235aa82d
    us-west-1:
      HVM64: ami-0bdb828fd58c52235
      HVMG2: ami-066ee5fd4a9ef77f1
    eu-west-1:
      HVM64: ami-047bb4163c506cd98
      HVMG2: ami-0a7c483d527806435
    eu-west-2:
      HVM64: ami-f976839e
      HVMG2: NOT_SUPPORTED
    eu-west-3:
      HVM64: ami-0ebc281c20e89ba4b
      HVMG2: NOT_SUPPORTED
    eu-central-1:
      HVM64: ami-0233214e13e500f77
      HVMG2: ami-06223d46a6d0661c7
    ap-northeast-1:
      HVM64: ami-06cd52961ce9f0d85
      HVMG2: ami-053cdd503598e4a9d
    ap-northeast-2:
      HVM64: ami-0a10b2721688ce9d2
      HVMG2: NOT_SUPPORTED
    ap-northeast-3:
      HVM64: ami-0d98120a9fb693f07
      HVMG2: NOT_SUPPORTED
    ap-southeast-1:
      HVM64: ami-08569b978cc4dfa10
      HVMG2: ami-0be9df32ae9f92309
    ap-southeast-2:
      HVM64: ami-09b42976632b27e9b
      HVMG2: ami-0a9ce9fecc3d1daf8
    ap-south-1:
      HVM64: ami-0912f71e06545ad88
      HVMG2: ami-097b15e89dbdcfcf4
    us-east-2:
      HVM64: ami-0b59bfac6be064b78
      HVMG2: NOT_SUPPORTED
    ca-central-1:
      HVM64: ami-0b18956f
      HVMG2: NOT_SUPPORTED
    sa-east-1:
      HVM64: ami-07b14488da8ea02a0
      HVMG2: NOT_SUPPORTED
    cn-north-1:
      HVM64: ami-0a4eaf6c4454eda75
      HVMG2: NOT_SUPPORTED
    cn-northwest-1:
      HVM64: ami-6b6a7d09
      HVMG2: NOT_SUPPORTED
Resources:
  WebServerInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref InstanceType
          - Arch
      InstanceType: !Ref InstanceType
      SecurityGroups:
        - !Ref WebServerSecurityGroup
      KeyName: !Ref KeyName
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable HTTP access via port 80
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref SSHLocation
Outputs:
  WebsiteURL:
    Description: URL for newly created LAMP stack
    Value: !Join 
      - ''
      - - 'http://'
        - !GetAtt 
          - WebServerInstance
          - PublicDnsName</code></pre>
   
    <h2 id="deployment-walkthrough-lamp-install">Step 2: Add helper script for the LAMP
        installation</h2>

    <p>You'll build on the previous basic Amazon EC2 template to automatically install Apache, MySQL,
      and PHP. To install the applications, you'll add a <code class="code">UserData</code> property and
        <code class="code">Metadata</code> property. However, the template won't configure and start the
      applications until the next section.</p>
    
    <p>The <code class="code">UserData</code> property runs two shell commands: install the CloudFormation helper
      scripts and then run the <code class="code">cfn-init</code> helper script. Because the helper scripts are
      updated periodically, running the <code class="code">yum install -y aws-cfn-bootstrap</code> command
      ensures that you get the latest helper scripts. When you run <code class="code">cfn-init</code>, it reads
      metadata from the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/TemplateReference/aws-resource-init.html">AWS::CloudFormation::Init</a> resource, which describes the actions to be carried out
      by <code class="code">cfn-init</code>. For example, you can use <code class="code">cfn-init</code> and
        <code class="code">AWS::CloudFormation::Init</code> to install packages, write files to disk, or start a
      service. In our case, <code class="code">cfn-init</code> installs the listed packages (httpd, mysql, and
      php) and creates the <code>/var/www/html/index.php</code> file (a sample PHP
      application).</p>
    <p>In the following example, sections marked with an ellipsis (<code class="code">...</code>) are omitted
      for brevity.</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (yaml)--><code class="yaml ">AWSTemplateFormatVersion: 2010-09-09
Description: 'AWS CloudFormation Sample Template LAMP_Install_Only: ...'
Resources:
  WebServerInstance:
    Type: AWS::EC2::Instance
    Metadata:
      Comment1: Configure the bootstrap helpers to install the Apache Web Server and PHP
      Comment2: Save website content to /var/www/html/index.php
      AWS::CloudFormation::Init:
        configSets:
          Install:
            - Install
        Install:
          packages:
            yum:
              mysql: []
              mysql-server: []
              mysql-libs: []
              httpd: []
              php: []
              php-mysql: []
          files:
            /var/www/html/index.php:
              content: !Join 
                - ''
                - - |
                    &lt;html&gt;
                  - |2
                      &lt;head&gt;
                  - |2
                        &lt;title&gt;AWS CloudFormation PHP Sample&lt;/title&gt;
                  - |2
                        &lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
                  - |2
                      &lt;/head&gt;
                  - |2
                      &lt;body&gt;
                  - |2
                        &lt;h1&gt;Welcome to the AWS CloudFormation PHP Sample&lt;/h1&gt;
                  - |2
                        &lt;p/&gt;
                  - |2
                        &lt;?php
                  - |2
                          // Print out the current data and time
                  - |2
                          print "The Current Date and Time is: &lt;br/&gt;";
                  - |2
                          print date("g:i A l, F j Y.");
                  - |2
                        ?&gt;
                  - |2
                        &lt;p/&gt;
                  - |2
                        &lt;?php
                  - |2
                          // Setup a handle for CURL
                  - |2
                          $curl_handle=curl_init();
                  - |2
                          curl_setopt($curl_handle,CURLOPT_CONNECTTIMEOUT,2);
                  - |2
                          curl_setopt($curl_handle,CURLOPT_RETURNTRANSFER,1);
                  - |2
                          // Get the hostname of the instance from the instance metadata
                  - |2
                          curl_setopt($curl_handle,CURLOPT_URL,'http://169.254.169.254/latest/meta-data/public-hostname');
                  - |2
                          $hostname = curl_exec($curl_handle);
                  - |2
                          if (empty($hostname))
                  - |2
                          <span>{</span>
                  - |2
                            print "Sorry, for some reason, we got no hostname back &lt;br /&gt;";
                  - |2
                          }
                  - |2
                          else
                  - |2
                          <span>{</span>
                  - |2
                            print "Server = " . $hostname . "&lt;br /&gt;";
                  - |2
                          }
                  - |2
                          // Get the instance-id of the instance from the instance metadata
                  - |2
                          curl_setopt($curl_handle,CURLOPT_URL,'http://169.254.169.254/latest/meta-data/instance-id');
                  - |2
                          $instanceid = curl_exec($curl_handle);
                  - |2
                          if (empty($instanceid))
                  - |2
                          <span>{</span>
                  - |2
                            print "Sorry, for some reason, we got no instance id back &lt;br /&gt;";
                  - |2
                          }
                  - |2
                          else
                  - |2
                          <span>{</span>
                  - |2
                            print "EC2 instance-id = " . $instanceid . "&lt;br /&gt;";
                  - |2
                          }
                  - '      $Database   = "'
                  - !Ref DBName
                  - |
                    ";
                  - '      $DBUser     = "'
                  - !Ref DBUsername
                  - |
                    ";
                  - '      $DBPassword = "'
                  - !Ref DBPassword
                  - |
                    ";
                  - |2
                          print "Database = " . $Database . "&lt;br /&gt;";
                  - |2
                          $dbconnection = mysql_connect('localhost', $DBUser, $DBPassword, $Database)
                  - |2
                                          or die("Could not connect: " . mysql_error());
                  - |2
                          print ("Connected to $Database successfully");
                  - |2
                          mysql_close($dbconnection);
                  - |2
                        ?&gt;
                  - |2
                        &lt;h2&gt;PHP Information&lt;/h2&gt;
                  - |2
                        &lt;p/&gt;
                  - |2
                        &lt;?php
                  - |2
                          phpinfo();
                  - |2
                        ?&gt;
                  - |2
                      &lt;/body&gt;
                  - |
                    &lt;/html&gt;
              mode: '000600'
              owner: apache
              group: apache
          services:
            sysvinit:
              httpd:
                enabled: 'true'
                ensureRunning: 'true'
    Properties:
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref InstanceType
          - Arch
      InstanceType: !Ref InstanceType
      SecurityGroups:
        - !Ref WebServerSecurityGroup
      KeyName: !Ref KeyName
      UserData: !Base64
        Fn::Sub: |-
          #!/bin/bash -xe
          yum update -y aws-cfn-bootstrap
          # Install the files and packages from the metadata
          /opt/aws/bin/cfn-init -v --stack $<span>{</span>AWS::StackName} --resource WebServerInstance --configsets Install --region $<span>{</span>AWS::Region}</code></pre>
   
    <h2 id="deployment-walkthrough-config">Step 3: Expand the scripts to configure
        Apache, MySQL, and PHP</h2>

    <p>Now that we have a template that installs Linux, Apache, MySQL, and PHP, we'll need to
      expand the template so that it automatically configures and runs Apache, MySQL, and PHP. In
      the following example, we expand on the <code class="code">Parameters</code> section,
        <code class="code">AWS::CloudFormation::Init</code> resource, and <code class="code">UserData</code> property to
      complete the configuration. As with the previous template, sections marked with an ellipsis
      (...) are omitted for brevity. Additions to the template are shown in red italic text.</p>
    <p>The example defines the <code class="code">DBUsername</code> and <code class="code">DBPassword</code> parameters
      with their <code class="code">NoEcho</code> property set to <code class="code">true</code>. If you set
        theÂ <code class="code">NoEcho</code>Â attribute toÂ <code class="code">true</code>, CloudFormation returns the parameter
      value masked as asterisks (*****) for any calls that describe the stack or stack events,
      except for information stored in the locations specified below.</p>
    <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>Important</h6></div><div class="awsdocs-note-text"><p>Using the <code class="code">NoEcho</code> attribute does not mask any information stored in the following:</p><div class="itemizedlist">
           
           
           
         <ul class="itemizedlist"><li class="listitem">
           <p>The <code class="code">Metadata</code> template section. CloudFormation does not transform, modify, or redact any
            information you include in the <code class="code">Metadata</code> section. For more information, see 
            <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/metadata-section-structure.html">Metadata</a>.</p>
          </li><li class="listitem">
           <p>The <code class="code">Outputs</code> template section. For more information, see
            <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/outputs-section-structure.html">Outputs</a>.</p>
          </li><li class="listitem">
           <p>The <code class="code">Metadata</code> attribute of a resource definition. For more information, see
            <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/TemplateReference/aws-attribute-metadata.html"><code class="code">Metadata</code> attribute</a>.</p>
          </li></ul></div><p>We strongly recommend you do not use these mechanisms to include sensitive information, such as
          passwords or secrets.</p></div></div>
    <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>Important</h6></div><div class="awsdocs-note-text"><p>Rather than embedding sensitive information directly in your CloudFormation templates, we recommend you use dynamic parameters in the stack template to
reference sensitive information that is stored and managed outside of CloudFormation, such as in the AWS Systems Manager Parameter Store or AWS Secrets Manager.</p><p>For more information, see the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/security-best-practices.html#creds">Do not embed credentials in your templates</a> best practice.</p></div></div>
    <p>The example adds more parameters to obtain information for configuring the MySQL database,
      such as the database name, user name, password, and root password. The parameters also contain
      constraints that catch incorrectly formatted values before CloudFormation creates the
      stack.</p>
    <p>In the <code class="code">AWS::CloudFormation::Init</code> resource, we added a MySQL setup file,
      containing the database name, user name, and password. The example also adds a
        <code class="code">services</code> property to ensure that the <code class="code">httpd</code> and <code class="code">mysqld</code>
      services are running (<code class="code">ensureRunning</code> set to <code class="code">true</code>) and to ensure that
      the services are restarted if the instance is rebooted (<code class="code">enabled</code> set to
        <code class="code">true</code>). A good practice is to also include the <code class="code">cfn-hup</code> helper
      script, with which you can make configuration updates to running instances by updating the
      stack template. For example, you could change the sample PHP application and then run a stack
      update to deploy the change.</p>
    <p>In order to run the MySQL commands after the installation is complete, the example adds
      another configuration set to run the commands. Configuration sets are useful when you have a
      series of tasks that must be completed in a specific order. The example first runs the
        <code class="code">Install</code> configuration set and then the <code class="code">Configure</code> configuration
      set. The <code class="code">Configure</code> configuration set specifies the database root password and
      then creates a database. In the commands section, the commands are processed in alphabetical
      order by name, so the example adds a number before each command name to indicate its desired
      run order.</p>

    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (yaml)--><code class="yaml ">AWSTemplateFormatVersion: 2010-09-09
Description: &gt;-
  AWS CloudFormation Sample Template LAMP_Single_Instance: Create a LAMP stack
  using a single EC2 instance and a local MySQL database for storage. This
  template demonstrates using the AWS CloudFormation bootstrap scripts to
  install the packages and files necessary to deploy the Apache web server, PHP
  and MySQL at instance launch time. **WARNING** This template creates an Amazon
  EC2 instance. You will be billed for the AWS resources used if you create a
  stack from this template.
Parameters:
  <code class="replaceable">DBName:
    Default: MyDatabase
    Description: MySQL database name
    Type: String
    MinLength: '1'
    MaxLength: '64'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters
  DBUsername:
    NoEcho: 'true'
    Description: Username for MySQL database access
    Type: String
    MinLength: '1'
    MaxLength: '16'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: Must begin with a letter and contain only alphanumeric characters
  DBPassword:
    NoEcho: 'true'
    Description: Password for MySQL database access
    Type: String
    MinLength: '1'
    MaxLength: '41'
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: Must contain only alphanumeric characters
  DBRootPassword:
    NoEcho: 'true'
    Description: Root password for MySQL
    Type: String
    MinLength: '1'
    MaxLength: '41'
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: Must contain only alphanumeric characters</code>
Resources:
  WebServerInstance:
    Type: AWS::EC2::Instance
    Metadata:
      Comment1: &gt;-
        Configure the bootstrap helpers to install the Apache Web Server and
        PHP
      Comment2: Save website content to /var/www/html/index.php
      AWS::CloudFormation::Init:
        configSets:
          <code class="replaceable">InstallAndRun:
            - Install
            - Configure</code>
        Install:
          packages:
            yum:
              mysql: []
              mysql-server: []
              mysql-libs: []
              httpd: []
              php: []
              php-mysql: []
          files:
            /var/www/html/index.php:
              content:
                ...: null
              mode: '000600'
              owner: apache
              group: apache
            <code class="replaceable">/tmp/setup.mysql:
              content: !Sub |
                CREATE DATABASE $<span>{</span>DBName};
                GRANT ALL ON $<span>{</span>DBName}.* TO '$<span>{</span>DBUsername}'@localhost IDENTIFIED BY '$<span>{</span>DBPassword}';
              mode: '000400'
              owner: root
              group: root
            /etc/cfn/cfn-hup.conf:
              content: !Sub |
                [main]
                stack=$<span>{</span>AWS::StackId}
                region=$<span>{</span>AWS::Region}
              mode: '000400'
              owner: root
              group: root
            /etc/cfn/hooks.d/cfn-auto-reloader.conf:
              content: !Sub |-
                [cfn-auto-reloader-hook]
                triggers=post.update
                path=Resources.WebServerInstance.Metadata.AWS::CloudFormation::Init
                action=/opt/aws/bin/cfn-init -v --stack $<span>{</span>AWS::StackName} --resource WebServerInstance --configsets InstallAndRun --region $<span>{</span>AWS::Region}
                runas=root</code>
          <code class="replaceable">services:
            sysvinit:
              mysqld:
                enabled: 'true'
                ensureRunning: 'true'
              httpd:
                enabled: 'true'
                ensureRunning: 'true'
              cfn-hup:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - /etc/cfn/cfn-hup.conf
                  - /etc/cfn/hooks.d/cfn-auto-reloader.conf</code>
        <code class="replaceable">Configure:
          commands:
            01_set_mysql_root_password:
              command: !Sub |-
                mysqladmin -u root password '$<span>{</span>DBRootPassword}'
              test: !Sub |-
                $(mysql $<span>{</span>DBName} -u root --password='$<span>{</span>DBRootPassword}' &gt;/dev/null 2&gt;&amp;1 &lt;/dev/null); (( $? != 0 ))
            02_create_database:
              command: !Sub |-
                mysql -u root --password='$<span>{</span>DBRootPassword}' &lt; /tmp/setup.mysql
              test: !Sub |-
                $(mysql $<span>{</span>DBName} -u root --password='$<span>{</span>DBRootPassword}' &gt;/dev/null 2&gt;&amp;1 &lt;/dev/null); (( $? != 0 ))</code>
    Properties:
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref InstanceType
          - Arch
      InstanceType: !Ref InstanceType
      SecurityGroups:
        - !Ref WebServerSecurityGroup
      KeyName: !Ref KeyName
      UserData: !Base64
        Fn::Sub: |-
          #!/bin/bash -xe
          yum update -y aws-cfn-bootstrap
          # Install the files and packages from the metadata
          /opt/aws/bin/cfn-init -v --stack $<span>{</span>AWS::StackName} --resource WebServerInstance --configsets <code class="replaceable">InstallAndRun</code> --region $<span>{</span>AWS::Region}
  WebServerSecurityGroup:
    ...: 
Outputs:
  ...: ...</code></pre>
   
    <h2 id="deployment-walkthrough-cfn-signal">Step 4: Add the creation policy and signal
        configuration</h2>

    <p>Finally, you need a way to instruct CloudFormation to complete stack creation only after all
      the services (such as Apache and MySQL) are running and not after all the stack resources are
      created. In other words, if you use the template from the earlier section to launch a stack,
      CloudFormation sets the status of the stack as <code class="code">CREATE_COMPLETE</code> after it successfully
      creates all the resources. However, if one or more services failed to start, CloudFormation still
      sets the stack status as <code class="code">CREATE_COMPLETE</code>. To prevent the status from changing to
        <code class="code">CREATE_COMPLETE</code> until all the services have successfully started, you can add a
        <code class="code">CreationPolicy</code> attribute to the instance. This attribute puts the instance's
      status in <code class="code">CREATE_IN_PROGRESS</code> until CloudFormation receives the required number of
      success signals or the timeout period is exceeded, so you can control when the instance has
      been successfully created. For more information, see <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/TemplateReference/aws-attribute-creationpolicy.html">CreationPolicy
        attribute</a>.</p>
    <p>The following example adds a creation policy to the Amazon EC2 instance to ensure that
        <code class="code">cfn-init</code> completes the LAMP installation and configuration before the stack
      creation is completed. In conjunction with the creation policy, the example needs to run the
        <code class="code">cfn-signal</code> helper script to signal CloudFormation when all the applications are
      installed and configured. For more information, see <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/TemplateReference/cfn-signal.html">cfn-signal</a>.</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (yaml)--><code class="yaml ">AWSTemplateFormatVersion: 2010-09-09
Description: 'AWS CloudFormation Sample Template LAMP_Single_Instance: ...'
Resources:
  WebServerInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref InstanceType
          - Arch
      InstanceType: !Ref InstanceType
      SecurityGroups:
        - !Ref WebServerSecurityGroup
      KeyName: !Ref KeyName
      UserData: !Base64
        Fn::Sub: |-
          #!/bin/bash -xe
          yum update -y aws-cfn-bootstrap
          # Install the files and packages from the metadata
          /opt/aws/bin/cfn-init -v --stack $<span>{</span>AWS::StackName} --resource WebServerInstance --configsets InstallAndRun --region $<span>{</span>AWS::Region}
          # Signal the status from cfn-init
          /opt/aws/bin/cfn-signal -e $? --stack $<span>{</span>AWS::StackName} --resource WebServerInstance --region $<span>{</span>AWS::Region}
    CreationPolicy:
      ResourceSignal:
        Timeout: PT5M
  WebServerSecurityGroup:
    ...: ...</code></pre>

    <p>The creation policy attribute uses the ISO 8601 format to define a timeout period of 5
      minutes. And because you're waiting for 1 instance to be configured, you only need to wait for
      one success signal, which is the default count.</p>
    <p>In the <code class="code">UserData</code> property, the template runs the <code class="code">cfn-signal</code>
      script to send a success signal with an exit code if all the services are configured and
      started successfully. When you use the <code class="code">cfn-signal</code> script, you must include the
      stack ID or name and the logical ID of the resource that you want to signal. If the
      configuration fails, <code class="code">cfn-signal</code> sends a failure signal that causes the resource
      creation to fail. The resource creation also fails if CloudFormation doesn't receive a success
      signal within the timeout period.</p>
    <p>The following example shows the final complete template.</p>
    <pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (yaml)--><code class="yaml ">AWSTemplateFormatVersion: 2010-09-09
Description: &gt;-
  AWS CloudFormation Sample Template LAMP_Single_Instance: Create a LAMP stack
  using a single EC2 instance and a local MySQL database for storage. This
  template demonstrates using the AWS CloudFormation bootstrap scripts to
  install the packages and files necessary to deploy the Apache web server, PHP
  and MySQL at instance launch time. **WARNING** This template creates an Amazon
  EC2 instance. You will be billed for the AWS resources used if you create a
  stack from this template.
Parameters:
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
  DBName:
    Default: MyDatabase
    Description: MySQL database name
    Type: String
    MinLength: '1'
    MaxLength: '64'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric characters.
  DBUser:
    NoEcho: 'true'
    Description: Username for MySQL database access
    Type: String
    MinLength: '1'
    MaxLength: '16'
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric characters.
  DBPassword:
    NoEcho: 'true'
    Description: Password for MySQL database access
    Type: String
    MinLength: '1'
    MaxLength: '41'
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: must contain only alphanumeric characters.
  DBRootPassword:
    NoEcho: 'true'
    Description: Root password for MySQL
    Type: String
    MinLength: '1'
    MaxLength: '41'
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: must contain only alphanumeric characters.
  InstanceType:
    Description: WebServer EC2 instance type
    Type: String
    Default: t2.small
    AllowedValues:
      - t1.micro
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
      - m1.small
      - m1.medium
      - m1.large
      - m1.xlarge
      - m2.xlarge
      - m2.2xlarge
      - m2.4xlarge
      - m3.medium
      - m3.large
      - m3.xlarge
      - m3.2xlarge
      - m4.large
      - m4.xlarge
      - m4.2xlarge
      - m4.4xlarge
      - m4.10xlarge
      - c1.medium
      - c1.xlarge
      - c3.large
      - c3.xlarge
      - c3.2xlarge
      - c3.4xlarge
      - c3.8xlarge
      - c4.large
      - c4.xlarge
      - c4.2xlarge
      - c4.4xlarge
      - c4.8xlarge
      - g2.2xlarge
      - g2.8xlarge
      - r3.large
      - r3.xlarge
      - r3.2xlarge
      - r3.4xlarge
      - r3.8xlarge
      - i2.xlarge
      - i2.2xlarge
      - i2.4xlarge
      - i2.8xlarge
      - d2.xlarge
      - d2.2xlarge
      - d2.4xlarge
      - d2.8xlarge
      - hi1.4xlarge
      - hs1.8xlarge
      - cr1.8xlarge
      - cc2.8xlarge
      - cg1.4xlarge
    ConstraintDescription: must be a valid EC2 instance type.
  SSHLocation:
    Description: ' The IP address range that can be used to SSH to the EC2 instances'
    Type: String
    MinLength: '9'
    MaxLength: '18'
    Default: 0.0.0.0/0
    AllowedPattern: '(\d<span>{</span>1,3})\.(\d<span>{</span>1,3})\.(\d<span>{</span>1,3})\.(\d<span>{</span>1,3})/(\d<span>{</span>1,2})'
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
Mappings:
  AWSInstanceType2Arch:
    t1.micro:
      Arch: HVM64
    t2.nano:
      Arch: HVM64
    t2.micro:
      Arch: HVM64
    t2.small:
      Arch: HVM64
    t2.medium:
      Arch: HVM64
    t2.large:
      Arch: HVM64
    m1.small:
      Arch: HVM64
    m1.medium:
      Arch: HVM64
    m1.large:
      Arch: HVM64
    m1.xlarge:
      Arch: HVM64
    m2.xlarge:
      Arch: HVM64
    m2.2xlarge:
      Arch: HVM64
    m2.4xlarge:
      Arch: HVM64
    m3.medium:
      Arch: HVM64
    m3.large:
      Arch: HVM64
    m3.xlarge:
      Arch: HVM64
    m3.2xlarge:
      Arch: HVM64
    m4.large:
      Arch: HVM64
    m4.xlarge:
      Arch: HVM64
    m4.2xlarge:
      Arch: HVM64
    m4.4xlarge:
      Arch: HVM64
    m4.10xlarge:
      Arch: HVM64
    c1.medium:
      Arch: HVM64
    c1.xlarge:
      Arch: HVM64
    c3.large:
      Arch: HVM64
    c3.xlarge:
      Arch: HVM64
    c3.2xlarge:
      Arch: HVM64
    c3.4xlarge:
      Arch: HVM64
    c3.8xlarge:
      Arch: HVM64
    c4.large:
      Arch: HVM64
    c4.xlarge:
      Arch: HVM64
    c4.2xlarge:
      Arch: HVM64
    c4.4xlarge:
      Arch: HVM64
    c4.8xlarge:
      Arch: HVM64
    g2.2xlarge:
      Arch: HVMG2
    g2.8xlarge:
      Arch: HVMG2
    r3.large:
      Arch: HVM64
    r3.xlarge:
      Arch: HVM64
    r3.2xlarge:
      Arch: HVM64
    r3.4xlarge:
      Arch: HVM64
    r3.8xlarge:
      Arch: HVM64
    i2.xlarge:
      Arch: HVM64
    i2.2xlarge:
      Arch: HVM64
    i2.4xlarge:
      Arch: HVM64
    i2.8xlarge:
      Arch: HVM64
    d2.xlarge:
      Arch: HVM64
    d2.2xlarge:
      Arch: HVM64
    d2.4xlarge:
      Arch: HVM64
    d2.8xlarge:
      Arch: HVM64
    hi1.4xlarge:
      Arch: HVM64
    hs1.8xlarge:
      Arch: HVM64
    cr1.8xlarge:
      Arch: HVM64
    cc2.8xlarge:
      Arch: HVM64
  AWSInstanceType2NATArch:
    t1.micro:
      Arch: NATHVM64
    t2.nano:
      Arch: NATHVM64
    t2.micro:
      Arch: NATHVM64
    t2.small:
      Arch: NATHVM64
    t2.medium:
      Arch: NATHVM64
    t2.large:
      Arch: NATHVM64
    m1.small:
      Arch: NATHVM64
    m1.medium:
      Arch: NATHVM64
    m1.large:
      Arch: NATHVM64
    m1.xlarge:
      Arch: NATHVM64
    m2.xlarge:
      Arch: NATHVM64
    m2.2xlarge:
      Arch: NATHVM64
    m2.4xlarge:
      Arch: NATHVM64
    m3.medium:
      Arch: NATHVM64
    m3.large:
      Arch: NATHVM64
    m3.xlarge:
      Arch: NATHVM64
    m3.2xlarge:
      Arch: NATHVM64
    m4.large:
      Arch: NATHVM64
    m4.xlarge:
      Arch: NATHVM64
    m4.2xlarge:
      Arch: NATHVM64
    m4.4xlarge:
      Arch: NATHVM64
    m4.10xlarge:
      Arch: NATHVM64
    c1.medium:
      Arch: NATHVM64
    c1.xlarge:
      Arch: NATHVM64
    c3.large:
      Arch: NATHVM64
    c3.xlarge:
      Arch: NATHVM64
    c3.2xlarge:
      Arch: NATHVM64
    c3.4xlarge:
      Arch: NATHVM64
    c3.8xlarge:
      Arch: NATHVM64
    c4.large:
      Arch: NATHVM64
    c4.xlarge:
      Arch: NATHVM64
    c4.2xlarge:
      Arch: NATHVM64
    c4.4xlarge:
      Arch: NATHVM64
    c4.8xlarge:
      Arch: NATHVM64
    g2.2xlarge:
      Arch: NATHVMG2
    g2.8xlarge:
      Arch: NATHVMG2
    r3.large:
      Arch: NATHVM64
    r3.xlarge:
      Arch: NATHVM64
    r3.2xlarge:
      Arch: NATHVM64
    r3.4xlarge:
      Arch: NATHVM64
    r3.8xlarge:
      Arch: NATHVM64
    i2.xlarge:
      Arch: NATHVM64
    i2.2xlarge:
      Arch: NATHVM64
    i2.4xlarge:
      Arch: NATHVM64
    i2.8xlarge:
      Arch: NATHVM64
    d2.xlarge:
      Arch: NATHVM64
    d2.2xlarge:
      Arch: NATHVM64
    d2.4xlarge:
      Arch: NATHVM64
    d2.8xlarge:
      Arch: NATHVM64
    hi1.4xlarge:
      Arch: NATHVM64
    hs1.8xlarge:
      Arch: NATHVM64
    cr1.8xlarge:
      Arch: NATHVM64
    cc2.8xlarge:
      Arch: NATHVM64
  AWSRegionArch2AMI:
    af-south-1:
      HVM64: ami-064cc455f8a1ef504
      HVMG2: NOT_SUPPORTED
    ap-east-1:
      HVM64: ami-f85b1989
      HVMG2: NOT_SUPPORTED
    ap-northeast-1:
      HVM64: ami-0b2c2a754d5b4da22
      HVMG2: ami-09d0e0e099ecabba2
    ap-northeast-2:
      HVM64: ami-0493ab99920f410fc
      HVMG2: NOT_SUPPORTED
    ap-northeast-3:
      HVM64: ami-01344f6f63a4decc1
      HVMG2: NOT_SUPPORTED
    ap-south-1:
      HVM64: ami-03cfb5e1fb4fac428
      HVMG2: ami-0244c1d42815af84a
    ap-southeast-1:
      HVM64: ami-0ba35dc9caf73d1c7
      HVMG2: ami-0e46ce0d6a87dc979
    ap-southeast-2:
      HVM64: ami-0ae99b503e8694028
      HVMG2: ami-0c0ab057a101d8ff2
    ca-central-1:
      HVM64: ami-0803e21a2ec22f953
      HVMG2: NOT_SUPPORTED
    cn-north-1:
      HVM64: ami-07a3f215cc90c889c
      HVMG2: NOT_SUPPORTED
    cn-northwest-1:
      HVM64: ami-0a3b3b10f714a0ff4
      HVMG2: NOT_SUPPORTED
    eu-central-1:
      HVM64: ami-0474863011a7d1541
      HVMG2: ami-0aa1822e3eb913a11
    eu-north-1:
      HVM64: ami-0de4b8910494dba0f
      HVMG2: ami-32d55b4c
    eu-south-1:
      HVM64: ami-08427144fe9ebdef6
      HVMG2: NOT_SUPPORTED
    eu-west-1:
      HVM64: ami-015232c01a82b847b
      HVMG2: ami-0d5299b1c6112c3c7
    eu-west-2:
      HVM64: ami-0765d48d7e15beb93
      HVMG2: NOT_SUPPORTED
    eu-west-3:
      HVM64: ami-0caf07637eda19d9c
      HVMG2: NOT_SUPPORTED
    me-south-1:
      HVM64: ami-0744743d80915b497
      HVMG2: NOT_SUPPORTED
    sa-east-1:
      HVM64: ami-0a52e8a6018e92bb0
      HVMG2: NOT_SUPPORTED
    us-east-1:
      HVM64: ami-032930428bf1abbff
      HVMG2: ami-0aeb704d503081ea6
    us-east-2:
      HVM64: ami-027cab9a7bf0155df
      HVMG2: NOT_SUPPORTED
    us-west-1:
      HVM64: ami-088c153f74339f34c
      HVMG2: ami-0a7fc72dc0e51aa77
    us-west-2:
      HVM64: ami-01fee56b22f308154
      HVMG2: ami-0fe84a5b4563d8f27
Resources:
  WebServerInstance:
    Type: AWS::EC2::Instance
    Metadata:
      AWS::CloudFormation::Init:
        configSets:
          InstallAndRun:
            - Install
            - Configure
        Install:
          packages:
            yum:
              mysql: []
              mysql-server: []
              mysql-libs: []
              httpd: []
              php: []
              php-mysql: []
          files:
            /var/www/html/index.php:
              content: !Join 
                - ''
                - - |
                    &lt;html&gt;
                  - |2
                      &lt;head&gt;
                  - |2
                        &lt;title&gt;AWS CloudFormation PHP Sample&lt;/title&gt;
                  - |2
                        &lt;meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"&gt;
                  - |2
                      &lt;/head&gt;
                  - |2
                      &lt;body&gt;
                  - |2
                        &lt;h1&gt;Welcome to the AWS CloudFormation PHP Sample&lt;/h1&gt;
                  - |2
                        &lt;p/&gt;
                  - |2
                        &lt;?php
                  - |2
                          // Print out the current data and time
                  - |2
                          print "The Current Date and Time is: &lt;br/&gt;";
                  - |2
                          print date("g:i A l, F j Y.");
                  - |2
                        ?&gt;
                  - |2
                        &lt;p/&gt;
                  - |2
                        &lt;?php
                  - |2
                          // Setup a handle for CURL
                  - |2
                          $curl_handle=curl_init();
                  - |2
                          curl_setopt($curl_handle,CURLOPT_CONNECTTIMEOUT,2);
                  - |2
                          curl_setopt($curl_handle,CURLOPT_RETURNTRANSFER,1);
                  - |2
                          // Get the hostname of the intance from the instance metadata
                  - |2
                          curl_setopt($curl_handle,CURLOPT_URL,'http://169.254.169.254/latest/meta-data/public-hostname');
                  - |2
                          $hostname = curl_exec($curl_handle);
                  - |2
                          if (empty($hostname))
                  - |2
                          <span>{</span>
                  - |2
                            print "Sorry, for some reason, we got no hostname back &lt;br /&gt;";
                  - |2
                          }
                  - |2
                          else
                  - |2
                          <span>{</span>
                  - |2
                            print "Server = " . $hostname . "&lt;br /&gt;";
                  - |2
                          }
                  - |2
                          // Get the instance-id of the intance from the instance metadata
                  - |2
                          curl_setopt($curl_handle,CURLOPT_URL,'http://169.254.169.254/latest/meta-data/instance-id');
                  - |2
                          $instanceid = curl_exec($curl_handle);
                  - |2
                          if (empty($instanceid))
                  - |2
                          <span>{</span>
                  - |2
                            print "Sorry, for some reason, we got no instance id back &lt;br /&gt;";
                  - |2
                          }
                  - |2
                          else
                  - |2
                          <span>{</span>
                  - |2
                            print "EC2 instance-id = " . $instanceid . "&lt;br /&gt;";
                  - |2
                          }
                  - |2
                          $Database   = "localhost";
                  - '      $DBUser     = "'
                  - !Ref DBUser
                  - |
                    ";
                  - '      $DBPassword = "'
                  - !Ref DBPassword
                  - |
                    ";
                  - |2
                          print "Database = " . $Database . "&lt;br /&gt;";
                  - |2
                          $dbconnection = mysql_connect($Database, $DBUser, $DBPassword)
                  - |2
                                          or die("Could not connect: " . mysql_error());
                  - |2
                          print ("Connected to $Database successfully");
                  - |2
                          mysql_close($dbconnection);
                  - |2
                        ?&gt;
                  - |2
                        &lt;h2&gt;PHP Information&lt;/h2&gt;
                  - |2
                        &lt;p/&gt;
                  - |2
                        &lt;?php
                  - |2
                          phpinfo();
                  - |2
                        ?&gt;
                  - |2
                      &lt;/body&gt;
                  - |
                    &lt;/html&gt;
              mode: '000600'
              owner: apache
              group: apache
            /tmp/setup.mysql:
              content: !Sub |
                CREATE DATABASE $<span>{</span>DBName};
                GRANT ALL ON $<span>{</span>DBName}.* TO '$<span>{</span>DBUsername}'@localhost IDENTIFIED BY '$<span>{</span>DBPassword}';
              mode: '000400'
              owner: root
              group: root
            /etc/cfn/cfn-hup.conf:
              content: !Sub |
                [main]
                stack=$<span>{</span>AWS::StackId}
                region=$<span>{</span>AWS::Region}
              mode: '000400'
              owner: root
              group: root
            /etc/cfn/hooks.d/cfn-auto-reloader.conf:
              content: !Sub |-
                [cfn-auto-reloader-hook]
                triggers=post.update
                path=Resources.WebServerInstance.Metadata.AWS::CloudFormation::Init
                action=/opt/aws/bin/cfn-init -v --stack $<span>{</span>AWS::StackName} --resource WebServerInstance --configsets InstallAndRun --region $<span>{</span>AWS::Region}
                runas=root
              mode: '000400'
              owner: root
              group: root
          services:
            sysvinit:
              mysqld:
                enabled: 'true'
                ensureRunning: 'true'
              httpd:
                enabled: 'true'
                ensureRunning: 'true'
              cfn-hup:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - /etc/cfn/cfn-hup.conf
                  - /etc/cfn/hooks.d/cfn-auto-reloader.conf
        Configure:
          commands:
            01_set_mysql_root_password:
              command: !Sub |-
                mysqladmin -u root password '$<span>{</span>DBRootPassword}'
              test: !Sub |-
                $(mysql $<span>{</span>DBName} -u root --password='$<span>{</span>DBRootPassword}' &gt;/dev/null 2&gt;&amp;1 &lt;/dev/null); (( $? != 0 ))
            02_create_database:
              command: !Sub |-
                mysql -u root --password='$<span>{</span>DBRootPassword}' &lt; /tmp/setup.mysql
              test: !Sub |-
                $(mysql $<span>{</span>DBName} -u root --password='$<span>{</span>DBRootPassword}' &gt;/dev/null 2&gt;&amp;1 &lt;/dev/null); (( $? != 0 ))
    Properties:
      ImageId: !FindInMap 
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap 
          - AWSInstanceType2Arch
          - !Ref InstanceType
          - Arch
      InstanceType: !Ref InstanceType
      SecurityGroups:
        - !Ref WebServerSecurityGroup
      KeyName: !Ref KeyName
      UserData: !Base64
        Fn::Sub: |-
          #!/bin/bash -xe
          yum update -y aws-cfn-bootstrap
          # Install the files and packages from the metadata
          /opt/aws/bin/cfn-init -v --stack $<span>{</span>AWS::StackName} --resource WebServerInstance --configsets InstallAndRun --region $<span>{</span>AWS::Region}
          # Signal the status from cfn-init
          /opt/aws/bin/cfn-signal -e $? --stack $<span>{</span>AWS::StackName} --resource WebServerInstance --region $<span>{</span>AWS::Region}
    CreationPolicy:
      ResourceSignal:
        Timeout: PT5M
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable HTTP access via port 80
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '80'
          ToPort: '80'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp: !Ref SSHLocation
Outputs:
  WebsiteURL:
    Description: URL for newly created LAMP stack
    Value: !Join 
      - ''
      - - 'http://'
        - !GetAtt 
          - WebServerInstance
          - PublicDnsName</code></pre>
   
    <h2 id="deployment-walkthrough-related-resources">Related resources</h2>
    <p>You can view the JSON version of the template for this walkthrough at
      the following location: <a href="https://s3.amazonaws.com/cloudformation-templates-us-east-1/LAMP_Single_Instance.template" rel="noopener noreferrer" target="_blank"><span>LAMP_Single_Instance.template</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> for the us-east-1 AWS Region.</p>
    <p>For additional example LAMP stack templates that use more recent versions of Amazon Linux, see
        <a href="https://github.com/aws-samples/ec2-lamp-server" rel="noopener noreferrer" target="_blank"><span>ec2-lamp-server</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a> on the
      GitHub website.</p>
  <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./walkthrough-autoscaling.html">Create a scaled and load-balanced application</div><div id="next" class="next-link" accesskey="n" href="./updating.stacks.walkthrough.html">Updating a stack</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/deploying.applications.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/deploying.applications.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>