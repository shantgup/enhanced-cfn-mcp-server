<!-- Source URL: https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html -->
<!DOCTYPE html>
    <html xmlns="http://www.w3.org/1999/xhtml" lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Grant self-managed permissions - AWS CloudFormation</title><meta name="viewport" content="width=device-width,initial-scale=1" /><meta name="assets_root" content="/assets" /><meta name="target_state" content="stacksets-prereqs-self-managed" /><meta name="default_state" content="stacksets-prereqs-self-managed" /><link rel="icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="shortcut icon" type="image/ico" href="/assets/images/favicon.ico" /><link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" /><meta name="description" content="Describes how to create the IAM service roles required by StackSets to deploy across accounts and AWS Regions with self-managed permissions." /><meta name="deployment_region" content="IAD" /><meta name="product" content="AWS CloudFormation" /><meta name="guide" content="User Guide" /><meta name="abstract" content="Create and manage AWS infrastructure deployments predictably and repeatedly using AWS CloudFormation with this User Guide." /><meta name="guide-locale" content="en_us" /><meta name="tocs" content="toc-contents.json" /><link rel="canonical" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="id-id" /><link rel="alternative" href="https://docs.aws.amazon.com/id_id/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="id" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="de-de" /><link rel="alternative" href="https://docs.aws.amazon.com/de_de/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="de" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="en-us" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="en" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="es-es" /><link rel="alternative" href="https://docs.aws.amazon.com/es_es/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="es" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="fr-fr" /><link rel="alternative" href="https://docs.aws.amazon.com/fr_fr/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="fr" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="it-it" /><link rel="alternative" href="https://docs.aws.amazon.com/it_it/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="it" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="ja-jp" /><link rel="alternative" href="https://docs.aws.amazon.com/ja_jp/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="ja" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="ko-kr" /><link rel="alternative" href="https://docs.aws.amazon.com/ko_kr/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="ko" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="pt-br" /><link rel="alternative" href="https://docs.aws.amazon.com/pt_br/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="pt" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="zh-cn" /><link rel="alternative" href="https://docs.aws.amazon.com/zh_tw/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="zh-tw" /><link rel="alternative" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" hreflang="x-default" /><meta name="feedback-item" content="CloudFormation" /><meta name="this_doc_product" content="AWS CloudFormation" /><meta name="this_doc_guide" content="User Guide" /><head xmlns="http://www.w3.org/1999/xhtml"> <script defer="" src="/assets/r/awsdocs-doc-page.2.0.0.js"></script><link href="/assets/r/awsdocs-doc-page.2.0.0.css" rel="stylesheet"/></head>
<script defer="" id="awsc-panorama-bundle" type="text/javascript" src="https://prod.pa.cdn.uis.awsstatic.com/panorama-nav-init.js" data-config="{'appEntity':'aws-documentation','region':'us-east-1','service':'cloudformation'}"></script><meta id="panorama-serviceSubSection" value="User Guide" /><meta id="panorama-serviceConsolePage" value="Grant self-managed permissions" /></head><body class="awsdocs awsui"><div class="awsdocs-container"><awsdocs-header></awsdocs-header><awsui-app-layout id="app-layout" class="awsui-util-no-gutters" ng-controller="ContentController as $ctrl" header-selector="awsdocs-header" navigation-hide="false" navigation-width="$ctrl.navWidth" navigation-open="$ctrl.navOpen" navigation-change="$ctrl.onNavChange($event)" tools-hide="$ctrl.hideTools" tools-width="$ctrl.toolsWidth" tools-open="$ctrl.toolsOpen" tools-change="$ctrl.onToolsChange($event)"><div id="guide-toc" dom-region="navigation"><awsdocs-toc></awsdocs-toc></div><div id="main-column" dom-region="content" tabindex="-1"><awsdocs-view class="awsdocs-view"><div id="awsdocs-content"><head><title>Grant self-managed permissions - AWS CloudFormation</title><meta name="pdf" content="/pdfs/AWSCloudFormation/latest/UserGuide/cfn-ug.pdf#stacksets-prereqs-self-managed" /><meta name="rss" content="aws-cloudformation-user-guide-updates.rss" /><meta name="forums" content="https://repost.aws/tags/TAm3R3LNU3RfSX9L23YIpo3w" /><meta name="feedback" content="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" /><meta name="feedback-yes" content="feedbackyes.html?topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" /><meta name="feedback-no" content="feedbackno.html?topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html" /><meta name="keywords" content="CloudFormation,AWSCloudFormation,resource provisioning,resource configuration,infrastructure management,CloudFormer,CloudFormation stack,CloudFormation stackset,CloudFormation template,change set" /><script type="application/ld+json">
{
    "@context" : "https://schema.org",
    "@type" : "BreadcrumbList",
    "itemListElement" : [
      {
        "@type" : "ListItem",
        "position" : 1,
        "name" : "AWS",
        "item" : "https://aws.amazon.com"
      },
      {
        "@type" : "ListItem",
        "position" : 2,
        "name" : "AWS CloudFormation",
        "item" : "https://docs.aws.amazon.com/cloudformation/index.html"
      },
      {
        "@type" : "ListItem",
        "position" : 3,
        "name" : "User Guide",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide"
      },
      {
        "@type" : "ListItem",
        "position" : 4,
        "name" : "Managing stacks across accounts and Regions with StackSets",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/what-is-cfnstacksets.html"
      },
      {
        "@type" : "ListItem",
        "position" : 5,
        "name" : "Prerequisites for using AWS CloudFormation StackSets",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs.html"
      },
      {
        "@type" : "ListItem",
        "position" : 6,
        "name" : "Grant self-managed permissions",
        "item" : "https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/stacksets-prereqs.html"
      }
    ]
}
</script></head><body><div id="main"><div style="display: none"><a href="/pdfs/AWSCloudFormation/latest/UserGuide/cfn-ug.pdf#stacksets-prereqs-self-managed" target="_blank" rel="noopener noreferrer" title="Open PDF"></a></div><div id="breadcrumbs" class="breadcrumb"><a href="/index.html">Documentation</a><a href="/cloudformation/index.html">AWS CloudFormation</a><a href="Welcome.html">User Guide</a></div><div id="page-toc-src"><a href="#prereqs-self-managed-permissions">Self-managed permissions
                    overview</a><a href="#stacksets-prereqs-accountsetup">Give all users of the administrator
                    account permissions to manage stacks in all target accounts</a><a href="#stacksets-prereqs-advanced-perms">Set up advanced permissions
                    options for StackSet operations</a><a href="#confused-deputy-mitigation">Confused deputy prevention</a></div><div id="main-content" class="awsui-util-container"><div id="main-col-body"><awsdocs-language-banner data-service="$ctrl.pageService"></awsdocs-language-banner><h1 class="topictitle" id="stacksets-prereqs-self-managed">Grant self-managed permissions</h1><div class="awsdocs-page-header-container"><awsdocs-page-header></awsdocs-page-header><awsdocs-filter-selector id="awsdocs-filter-selector"></awsdocs-filter-selector></div><p>This topic provides instructions on how to create the IAM service roles required by
            StackSets to deploy across accounts and AWS Regions with
                <em>self-managed</em> permissions. These roles are necessary to
            establish a trusted relationship between the account you're administering the StackSet from
            and the account you're deploying stack instances to. Using this permissions model,
            StackSets can deploy to any AWS account in which you have permissions to create an
            IAM role. </p><p>To use <em>service-managed</em> permissions, see <a href="./stacksets-orgs-activate-trusted-access.html">Activate trusted
                access</a> instead.</p><div class="highlights" id="inline-topiclist"><h6>Topics</h6><ul><li><p><a href="#prereqs-self-managed-permissions">Self-managed permissions
                    overview</a></p></li><li><p><a href="#stacksets-prereqs-accountsetup">Give all users of the administrator
                    account permissions to manage stacks in all target accounts</a></p></li><li><p><a href="#stacksets-prereqs-advanced-perms">Set up advanced permissions
                    options for StackSet operations</a></p></li><li><p><a href="#confused-deputy-mitigation">Set up global keys to mitigate confused
                    deputy problems</a></p></li></ul></div>
            <h2 id="prereqs-self-managed-permissions">Self-managed permissions
                    overview</h2>
            <p>Before you create a StackSet with self-managed permissions, you must have created
                IAM service roles in each account.</p>
            <p>The basic steps are:</p>
            <div class="orderedlist">
                 
                 
                 
            <ol><li>
                    <p>Determine which AWS account is the <em>administrator
                            account</em>.</p>
                    <p>StackSets are created in this administrator account. A
                            <em>target account</em> is the account in which you create
                        individual stacks that belong to a StackSet.</p>
                </li><li>
                    <p>Determine how you want to structure permissions for the StackSet.</p>
                    <p>The simplest (and most permissive) permissions configuration is where you
                        give <em>all</em> users and groups in the administrator account
                        the ability to create and update <em>all</em> the StackSets
                        managed through that account. If you need finer-grained control, you can set
                        up permissions to specify:</p>
                    <div class="itemizedlist">
                         
                         
                         
                    <ul class="itemizedlist"><li class="listitem">
                            <p>Which users and groups can perform StackSet operations in which target
                                accounts.</p>
                        </li><li class="listitem">
                            <p>Which resources users and groups can include in their
                                StackSets.</p>
                        </li><li class="listitem">
                            <p>Which StackSet operations specific users and groups can
                                perform.</p>
                        </li></ul></div>
                </li><li>
                    <p>Create the necessary IAM service roles in your administrator and target
                        accounts to define the permissions you want. </p>
                    <p>Specifically, the two required roles are:</p>
                    <div class="itemizedlist">
                         
                         
                    <ul class="itemizedlist"><li class="listitem">
                            <p><b>AWSCloudFormationStackSetAdministrationRole</b>
                                â This role is deployed to the administrator account.</p>
                        </li><li class="listitem">
                            <p><b>AWSCloudFormationStackSetExecutionRole</b>
                                â This role is deployed to all accounts where you create
                                stack instances.</p>
                        </li></ul></div>
                </li></ol></div>

         
            <h2 id="stacksets-prereqs-accountsetup">Give all users of the administrator
                    account permissions to manage stacks in all target accounts</h2>
            <p>This section shows you how to set up permissions to allow all users and groups of
                the administrator account to perform StackSet operations in all target accounts. It
                guides you through creating the required IAM service roles in your administrator
                and target accounts. Anyone in the administrator account can then create, update, or
                delete any stacks across any of the target accounts. </p>
            <p>By structuring permissions in this manner, users don't pass an administration role
                when creating or updating a StackSet.</p>
            <div class="mediaobject">
                 
                    <img src="/images/AWSCloudFormation/latest/UserGuide/images/stacksets_perms_master_target.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="Any user in the administrator account can then create any StackSet in target accounts after setting up a trust relationship." style="max-width:100%" />
                 
                 
            </div>
            
            <awsdocs-tabs><dl style="display: none">
                <dt>Administrator account</dt><dd tab-id="administrator-account">
                        <p>In the administrator account, create an IAM role named
                                <b>AWSCloudFormationStackSetAdministrationRole</b>.
                            </p>
                        <p>You can do this by creating a stack from the CloudFormation template
                            available from <a href="https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/AWSCloudFormationStackSetAdministrationRole.yml" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/AWSCloudFormationStackSetAdministrationRole.yml</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>. </p>
                        <div class="example"><h6>Example permissions policy</h6><div class="example-contents"><p>The administration role created by the preceding template includes
                                the following permissions policy. </p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Action": [
        "sts:AssumeRole"
      ],
      "Resource": [
        "arn:aws:iam::*:role/AWSCloudFormationStackSetExecutionRole"
      ],
      "Effect": "Allow"
    }
  ]
}</code></pre></div></div>
                        <div class="example"><h6>Example trust policy 1</h6><div class="example-contents"><p>The preceding template also includes the following trust policy
                                that grants the service permission to use the administration role
                                and the permissions attached to the role.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "Service": "cloudformation.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}</code></pre></div></div>
                        <div class="example"><h6>Example trust policy 2</h6><div class="example-contents"><p>To deploy stack instances into a target account that resides in a
                                Region that's disabled by default, you must also
                                include the regional service principal for that Region. Each
                                Region that's disabled by default will have its own
                                regional service principal.</p><p>The following example trust policy grants the service permission
                                to use the administration role in the Asia Pacific (Hong Kong) Region
                                    (<code class="code">ap-east-1</code>), a Region that's
                                disabled by default. </p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "Service": [
            "cloudformation.amazonaws.com",
            "<code class="replaceable">cloudformation.ap-east-1.amazonaws.com</code>"
         ]
      },
      "Action": "sts:AssumeRole"
    }
  ]
}</code></pre><p>For more information, see <a href="./stacksets-opt-in-regions.html">Prepare to perform StackSet operations in
                AWS Regions that are disabled by default</a>. For a list of Region
                                codes, see <a href="https://docs.aws.amazon.com/general/latest/gr/rande.html#regional-endpoints">Regional
                                    endpoints</a> in the <em>AWS General Reference
                                    Guide</em>.</p></div></div>
                    </dd>
                
                <dt>Target accounts</dt><dd tab-id="target-accounts">
                        <p>In each target account, create a service role named
                                <b>AWSCloudFormationStackSetExecutionRole</b> that
                            trusts the administrator account. The role must have this exact name.
                            You can do this by creating a stack from the CloudFormation template
                            available from <a href="https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/AWSCloudFormationStackSetExecutionRole.yml" rel="noopener noreferrer" target="_blank"><span>https://s3.amazonaws.com/cloudformation-stackset-sample-templates-us-east-1/AWSCloudFormationStackSetExecutionRole.yml</span><awsui-icon class="awsdocs-link-icon" name="external"></awsui-icon></a>.
                            When you use this template, you are prompted to provide the account ID
                            of the administrator account with which your target account must have a
                            trust relationship.</p>
                        <div class="awsdocs-note awsdocs-important"><div class="awsdocs-note-title"><awsui-icon name="status-warning" variant="error"></awsui-icon><h6>Important</h6></div><div class="awsdocs-note-text"><p>Be aware that this template grants administrator access. After you
                                use the template to create a target account execution role, you must
                                scope the permissions in the policy statement to the types of
                                resources that you are creating by using StackSets.</p></div></div>
                        <p>The target account service role requires permissions to perform any
                            operations that are specified in your CloudFormation template. For example,
                            if your template is creating an S3 bucket, then you need permissions to
                            create new objects for S3. Your target account always needs full
                            CloudFormation permissions, which include permissions to create, update,
                            delete, and describe stacks. </p>
                        <div class="example"><h6>Example permissions policy 1</h6><div class="example-contents"><p>The role created by this template enables the following policy on
                                a target account.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Action": "*",
      "Resource": "*"
    }
  ]
}</code></pre></div></div>
                        <div class="example"><h6>Example permissions policy 2</h6><div class="example-contents"><p>The following example shows a policy statement with the
                                    <em>minimum</em> permissions for StackSets to work.
                                To create stacks in target accounts that use resources from services
                                other than CloudFormation, you must add those service actions and
                                resources to the
                                    <b>AWSCloudFormationStackSetExecutionRole</b>
                                policy statement for each target account.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Action": [
         "cloudformation:*"
      ],
      "Resource": "*"
    }
  ]
}</code></pre></div></div>
                        <div class="example"><h6>Example trust policy</h6><div class="example-contents"><p>The following trust relationship is created by the template. The
                                administrator account's ID is shown as
                                    <code class="replaceable">admin_account_id</code>.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "AWS": "arn:aws:iam::<code class="replaceable">admin_account_id</code>:root"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}</code></pre><p>You can configure the trust relationship of an existing target
                                account execution role to trust a specific role in the administrator
                                account. If you delete the role in the administrator account, and
                                create a new one to replace it, you must configure your target
                                account trust relationships with the new administrator account role,
                                represented by <code class="replaceable">admin_account_id</code> in the
                                preceding example.</p></div></div>
                    </dd>
            </dl></awsdocs-tabs>
         
            <h2 id="stacksets-prereqs-advanced-perms">Set up advanced permissions
                    options for StackSet operations</h2>
            <p>If you require finer-grained control over the StackSets that users and groups
                are creating through a single administrator account, you can use IAM roles to
                specify:</p>
            <div class="itemizedlist">
                 
                 
                 
            <ul class="itemizedlist"><li class="listitem">
                    <p>Which users and groups can perform StackSet operations in which target
                        accounts.</p>
                </li><li class="listitem">
                    <p>Which resources users and groups can include in their
                        StackSets.</p>
                </li><li class="listitem">
                    <p>Which StackSet operations specific users and groups can perform.</p>
                </li></ul></div>
             
                <h3 id="stacksets-prereqs-multiadmin">Control which users can perform
                        StackSet operations in specific target accounts</h3>
                <p>Use customized administration roles to control which users and groups can
                    perform StackSet operations in which target accounts. You might want to control
                    which users of the administrator account can perform StackSet operations in which
                    target accounts. To do this, you create a trust relationship between each target
                    account and a specific customized administration role, rather than creating the
                        <b>AWSCloudFormationStackSetAdministrationRole</b> service
                    role in the administrator account itself. You then activate specific users and
                    groups to use the customized administration role when performing StackSet operations
                    in a specific target account.</p>
                <p>For example, you can create Role A and Role B within your administrator
                    account. You can give Role A permissions to access target account 1 through
                    account 8. You can give Role B permissions to access target account 9 through
                    account 16.</p>
                <div class="mediaobject">
                     
                        <img src="/images/AWSCloudFormation/latest/UserGuide/images/stacksets_perms_admin_target.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="A trust relationship between a customized administration role and target accounts that allows users to create a StackSet." style="max-width:100%" />
                     
                     
                </div>
                <p>Setting up the necessary permissions involves defining a customized
                    administration role, creating a service role for the target account, and
                    granting users permission to pass the customized administration role when
                    performing StackSet operations.</p>
                <p>In general, here's how it works once you have the necessary permissions in
                    place: When creating a StackSet, the user must specify a customized administration
                    role. The user must have permission to pass the role to CloudFormation. In addition,
                    the customized administration role must have a trust relationship with the
                    target accounts specified for the StackSet. CloudFormation creates the StackSet and
                    associates the customized administration role with it. When updating a StackSet, the
                    user must explicitly specify a customized administration role, even if it's the
                    same customized administration role used with this StackSet previously. CloudFormation
                    uses that role to update the stack, subject to the requirements above.</p>

                
                <awsdocs-tabs><dl style="display: none">
                    <dt>Administrator account</dt><dd tab-id="administrator-account">
                            <div class="example"><h6>Example permissions policy</h6><div class="example-contents"><p>For each StackSet, create a customized administration role with
                                    permissions to assume the target account execution role. </p><p>The target account execution role name must be the same in
                                    every target account. If the role name is
                                        <b>AWSCloudFormationStackSetExecutionRole</b>,
                                    StackSets uses it automatically when creating a StackSet. If you
                                    specify a custom role name, users must provide the execution
                                    role name when creating a StackSet.</p><p>Create an <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_create_for-service.html">IAM
                                        service role</a> with a custom name and the following
                                    permissions policy. In the examples below,
                                        <code class="replaceable">custom_execution_role</code> refers to
                                    the execution role in the target accounts. </p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Action": [
        "sts:AssumeRole"
      ],
      "Resource": [
        "arn:aws:iam::<code class="replaceable">target_account_id</code>:role/<code class="replaceable">custom_execution_role</code>"
      ],
      "Effect": "Allow"
    }
  ]
}</code></pre><p>To specify multiple accounts in a single statement, separate
                                    them with commas.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json ">"Resource": [
  "arn:aws:iam::<code class="replaceable">target_account_id_1</code>:role/<code class="replaceable">custom_execution_role</code>", 
  "arn:aws:iam::<code class="replaceable">target_account_id_2</code>:role/<code class="replaceable">custom_execution_role</code>"
]</code></pre><p>You can specify all target accounts by using a wildcard (*)
                                    instead of an account ID.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json ">"Resource": [
  "arn:aws:iam::<code class="replaceable">*</code>:role/<code class="replaceable">custom_execution_role</code>"
]</code></pre></div></div>
                            <div class="example"><h6>Example trust policy 1</h6><div class="example-contents"><p>You must provide a trust policy for the service role to
                                    defines which IAM principals can assume the role.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span> 
  "Version": "2012-10-17", 
  "Statement": [ 
    <span>{</span> 
      "Effect": "Allow", 
      "Principal": <span>{</span> 
        "Service": "cloudformation.amazonaws.com" 
      }, 
      "Action": "sts:AssumeRole" 
    } 
  ] 
}</code></pre></div></div>
                            <div class="example"><h6>Example trust policy 2</h6><div class="example-contents"><p>To deploy stack instances into a target account that resides
                                    in a Region that's disabled by default, you must
                                    also include the regional service principal for that Region.
                                    Each Region that's disabled by default will have its own
                                    regional service principal.</p><p>The following example trust policy grants the service
                                    permission to use the administration role in the Asia Pacific (Hong Kong) Region
                                        (<code class="code">ap-east-1</code>), a Region that's
                                    disabled by default. </p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "Service": [
            "cloudformation.amazonaws.com",
            "<code class="replaceable">cloudformation.ap-east-1.amazonaws.com</code>"
         ]
      },
      "Action": "sts:AssumeRole"
    }
  ]
}</code></pre><p>For more information, see <a href="./stacksets-opt-in-regions.html">Prepare to perform StackSet operations in
                AWS Regions that are disabled by default</a>. For a list of Region
                                    codes, see <a href="https://docs.aws.amazon.com/general/latest/gr/rande.html#regional-endpoints">Regional endpoints</a> in the <em>AWS General
                                        Reference Guide</em>.</p></div></div>
                            <div class="example"><h6>Example pass role policy</h6><div class="example-contents"><p>You also need an IAM permissions policy for your IAM users
                                    that allows the user to pass the customized administration role
                                    when performing StackSet operations. For more information, see
                                        <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_passrole.html">Granting a user permissions to pass a role to an AWS
                                        service</a>.</p><p>In the example below,
                                        <code class="replaceable">customized_admin_role</code> refers to
                                    the administration role the user needs to pass.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Action": [
        "iam:GetRole",
        "iam:PassRole"
      ],
      "Resource": "arn:aws:iam::*:role/<code class="replaceable">customized_admin_role</code>"
    }
  ]
}</code></pre></div></div>
                        </dd>
                    
                    <dt>Target accounts</dt><dd tab-id="target-accounts">
                            <p>In each target account, create a service role that trusts the
                                customized administration role you want to use with this account. </p>
                            <p>The target account role requires permissions to perform any
                                operations that are specified in your CloudFormation template. For
                                example, if your template is creating an S3 bucket, then you need
                                permissions to create new objects in S3. Your target account always
                                needs full CloudFormation permissions, which include permissions to
                                create, update, delete, and describe stacks.</p>
                            <p>The target account role name must be the same in every target
                                account. If the role name is
                                    <b>AWSCloudFormationStackSetExecutionRole</b>,
                                StackSets uses it automatically when creating a StackSet. If you specify
                                a custom role name, users must provide the execution role name when
                                creating a StackSet.</p>
                            <div class="example"><h6>Example permissions policy</h6><div class="example-contents"><p>The following example shows a policy statement with the
                                        <em>minimum</em> permissions for StackSets to
                                    work. To create stacks in target accounts that use resources
                                    from services other than CloudFormation, you must add those service
                                    actions and resources to the permissions policy.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Action": [
        "cloudformation:*"
      ],
      "Resource": "*"
    }
  ]
}</code></pre></div></div>
                            <div class="example"><h6>Example trust policy</h6><div class="example-contents"><p>You must provide the following trust policy when you create
                                    the role to define the trust relationship.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17", 
  "Statement": [ 
    <span>{</span> 
      "Effect": "Allow", 
      "Principal": <span>{</span> 
      "AWS": "arn:aws:iam::<code class="replaceable">admin_account_id</code>:role/<code class="replaceable">customized_admin_role</code>" 
      }, 
      "Action": "sts:AssumeRole"
    } 
  ] 
} </code></pre></div></div>
                        </dd>
                </dl></awsdocs-tabs>

             
             
                <h3 id="stacksets-prereqs-executionrole">Control the resources that
                        users can include in specific StackSets</h3>
                <p>Use customized execution roles to control which stack resources users and
                    groups can include in their StackSets. For example, you might want to set up
                    a group that can only include Amazon S3-related resources in the StackSets they
                    create, while another team can only include DynamoDB resources. To do this, you
                    create a trust relationship between the customized administration role for each
                    group and a customized execution role for each set of resources. The customized
                    execution role defines which stack resources can be included in StackSets.
                    The customized administration role resides in the administrator account, while
                    the customized execution role resides in each target account in which you want
                    to create StackSets using the defined resources. You then activate specific
                    users and groups to use the customized administration role when performing
                    StackSets operations.</p>
                <p>For example you can create customized administration roles A, B, and C in the
                    administrator account. Users and groups with permission to use Role A can create
                    StackSets containing the stack resources specifically listed in customized
                    execution role X, but not those in roles Y or Z, or resource not included in any
                    execution role.</p>
                <div class="mediaobject">
                     
                        <img src="/images/AWSCloudFormation/latest/UserGuide/images/stacksets_perms_admin_execution.png" class="aws-docs-img-whiteBg aws-docs-img-padding" alt="A trust relationship between a custom admin role and custom execution role in target accounts, allowing users to create a StackSet." style="max-width:100%" />
                     
                     
                </div>
                <p>When updating a StackSet, the user must explicitly specify a customized
                    administration role, even if it's the same customized administration role used
                    with this StackSet previously. CloudFormation performs the update using the customized
                    administration role specified, so long as the user has permissions to perform
                    operations on that StackSet.</p>
                <p>Similarly, the user can also specify a customized execution role. If they
                    specify a customized execution role, CloudFormation uses that role to update the
                    stack, subject to the requirements above. If the user doesn't specify a
                    customized execution role, CloudFormation performs the update using the customized
                    execution role previously associated with the StackSet, so long as the user has
                    permissions to perform operations on that StackSet.</p>
                
                <awsdocs-tabs><dl style="display: none">
                    <dt>Administrator account</dt><dd tab-id="administrator-account">
                            <p>Create a customized administration role in your administrator
                                account, as detailed in <a href="#stacksets-prereqs-multiadmin">Control which users can perform
                        StackSet operations in specific target accounts</a>. Include a trust
                                relationship between the customized administration role and the
                                customized execution roles that you want it to use.</p>
                            <div class="example"><h6>Example permissions policy</h6><div class="example-contents"><p>The following example is a permissions policy for both the
                                        <b>AWSCloudFormationStackSetExecutionRole</b>
                                    defined for the target account, in addition to a customized
                                    execution role.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17",
   "Statement": [
    <span>{</span>
      "Sid": "Stmt1487980684000",
      "Effect": "Allow",
      "Action": [
        "sts:AssumeRole" 
      ],
      "Resource": [ 
        "arn:aws:iam::*:role/AWSCloudFormationStackSetExecutionRole",
        "arn:aws:iam::*:role/<code class="replaceable">custom_execution_role</code>" 
      ]
    } 
  ]
}</code></pre></div></div>
                        </dd>
                    
                    <dt>Target accounts</dt><dd tab-id="target-accounts">
                            <p>In the target accounts in which you want to create your
                                StackSets, create a customized execution role that grants
                                permissions to the services and resources that you want users and
                                groups to be able to include in the StackSets.</p>
                            <div class="example"><h6>Example permissions policy</h6><div class="example-contents"><p>The following example provides the minimum permissions for
                                    StackSets, along with permission to create Amazon DynamoDB
                                    tables.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Action": [
        "cloudformation:*"
      ],
      "Resource": "*"
    },
    <span>{</span>
      "Effect": "Allow",
      "Action": [
        "dynamoDb:createTable"
      ],
      "Resource": "*"
    }
  ]
}</code></pre></div></div>
                            <div class="example"><h6>Example trust policy</h6><div class="example-contents"><p>You must provide the following trust policy when you create
                                    the role to define the trust relationship.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17", 
  "Statement": [ 
    <span>{</span> 
      "Effect": "Allow", 
      "Principal": <span>{</span> 
      "AWS": "arn:aws:iam::<code class="replaceable">admin_account_id</code>:role/<code class="replaceable">customized_admin_role</code>" 
      }, 
      "Action": "sts:AssumeRole"
    } 
  ] 
} </code></pre></div></div>
                        </dd>
                </dl></awsdocs-tabs>
             
             
                <h3 id="stacksets-prereqs-iam-actions">Set up permissions for specific
                        StackSet operations</h3>
                <p>In addition, you can set up permissions for which user and groups can perform
                    specific StackSet operations, such as creating, updating, or deleting StackSets
                    or stack instances. For more information, see <a href="https://docs.aws.amazon.com/service-authorization/latest/reference/list_awscloudformation.html">Actions, resources, and condition keys for CloudFormation</a> in the
                        <em>Service Authorization Reference</em>.</p>
             
         
            <h2 id="confused-deputy-mitigation">Set up global keys to mitigate confused
                    deputy problems</h2>
            <p>The confused deputy problem is a security issue where an entity that doesn't have
                permission to perform an action can coerce a more-privileged entity to perform the
                action. In AWS, cross-service impersonation can result in the confused deputy
                problem. Cross-service impersonation can occur when one service (the
                    <em>calling service</em>) calls another service (the
                    <em>called service</em>). The calling service can be manipulated to
                use its permissions to act on another customer's resources in a way it shouldn't
                otherwise have permission to access. To prevent this, AWS provides tools that help
                you protect your data for all services with service principals that have been given
                access to resources in your account.</p>
            <p>We recommend using the <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourcearn">aws:SourceArn</a> and <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourceaccount">aws:SourceAccount</a> global condition context keys in
                resource policies to limit the permissions that AWS CloudFormation StackSets gives another service to the
                resource. If you use both global condition context keys, the
                    <code class="code">aws:SourceAccount</code> value and the account in the
                    <code class="code">aws:SourceArn</code> value must use the same account ID when used in the
                same policy statement.</p>

            <p>The most effective way to protect against the confused deputy problem is to use
                the <code class="code">aws:SourceArn</code> global condition context key with the full ARN of the
                resource. If you don't know the full ARN of the resource or if you are specifying
                multiple resources, use the <code class="code">aws:SourceArn</code> global context condition key
                with wildcards (<code class="code">*</code>) for the unknown portions of the ARN. For example,
                        <code class="code">arn:aws:<code class="replaceable">cloudformation</code>::<code class="replaceable">123456789012</code>:*</code>.
                Whenever possible, use <code class="code">aws:SourceArn</code>, because it's more specific. Use
                    <code class="code">aws:SourceAccount</code> only when you can't determine the correct ARN or
                ARN pattern.</p>

            <p>When StackSets assumes the <b>Administration</b> role in your
                    <b>administrator</b> account, StackSets populates your
                    <b>administrator</b> account ID and StackSets Amazon Resource
                Name (ARN). Therefore, you can define conditions for <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_condition-keys.html#condition-keys-sourceaccount">global keys</a>
                <code class="code">aws:SourceAccount</code> and <code class="code">aws:SourceArn</code> in the trust
                relationships to prevent <a href="https://docs.aws.amazon.com/IAM/latest/UserGuide/confused-deputy.html">confused deputy
                problems</a>. The following example shows how you can use the
                    <code class="code">aws:SourceArn</code> and <code class="code">aws:SourceAccount</code> global condition
                context keys in StackSets to prevent the confused deputy problem.</p>
            
            <awsdocs-tabs><dl style="display: none">
                <dt>Administrator account</dt><dd tab-id="administrator-account">
                        <div class="example"><h6>Example Global keys for
                                    <code class="code">aws:SourceAccount</code> and
                                <code class="code">aws:SourceArn</code></h6><div class="example-contents"><p>When using StackSets, define the global keys
                                    <code class="code">aws:SourceAccount</code> and <code class="code">aws:SourceArn</code> in
                                your
                                    <b>AWSCloudFormationStackSetAdministrationRole</b>
                                trust policy to prevent confused deputy problems.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "Service": "cloudformation.amazonaws.com"
      },
      "Action": "sts:AssumeRole",
      "Condition": <span>{</span>
        "StringEquals": <span>{</span>
          "aws:SourceAccount": "<code class="replaceable">111122223333</code>"
        },
        "StringLike": <span>{</span>
          "aws:SourceArn": "arn:aws:cloudformation:*:<code class="replaceable">111122223333</code>:stackset/*"
        }
      }
    }
  ]
}</code></pre></div></div>
                        <div class="example"><h6>Example StackSets
                                ARNs</h6><div class="example-contents"><p>Specify your associated StackSets ARNs for finer
                                control.</p><pre class="programlisting"><div class="code-btn-container"><div class="btn-copy-code" title="Copy"><awsui-icon name="copy"></awsui-icon></div></div><!--DEBUG: cli (json)--><code class="json "><span>{</span>
  "Version": "2012-10-17",
  "Statement": [
    <span>{</span>
      "Effect": "Allow",
      "Principal": <span>{</span>
        "Service": "cloudformation.amazonaws.com"
      },
      "Action": "sts:AssumeRole",
      "Condition": <span>{</span>
        "StringEquals": <span>{</span>
          "aws:SourceAccount": "<code class="replaceable">111122223333</code>",
          "aws:SourceArn": [
            "arn:aws:cloudformation:<code class="replaceable">STACKSETS-REGION</code>:<code class="replaceable">111122223333</code>:stackset/<code class="replaceable">STACK-SET-ID-1</code>",
            "arn:aws:cloudformation:<code class="replaceable">STACKSETS-REGION</code>:<code class="replaceable">111122223333</code>:stackset/<code class="replaceable">STACK-SET-ID-2</code>",
          ]
        }
      }
    }
  ]
}</code></pre></div></div>
                    </dd>
            </dl></awsdocs-tabs>
        <awsdocs-copyright class="copyright-print"></awsdocs-copyright><awsdocs-thumb-feedback right-edge="{{$ctrl.thumbFeedbackRightEdge}}"></awsdocs-thumb-feedback></div><noscript><div><div><div><div id="js_error_message"><p><img src="https://d1ge0kk1l5kms0.cloudfront.net/images/G/01/webservices/console/warning.png" alt="Warning" /> <strong>Javascript is disabled or is unavailable in your browser.</strong></p><p>To use the Amazon Web Services Documentation, Javascript must be enabled. Please refer to your browser's Help pages for instructions.</p></div></div></div></div></noscript><div id="main-col-footer" class="awsui-util-font-size-0"><div id="doc-conventions"><a target="_top" href="/general/latest/gr/docconventions.html">Document Conventions</a></div><div class="prev-next"><div id="previous" class="prev-link" accesskey="p" href="./stacksets-opt-in-regions.html">Enable AWS Regions that are
                disabled by default</div><div id="next" class="next-link" accesskey="n" href="./stacksets-orgs-activate-trusted-access.html">Activate trusted
                access</div></div></div><awsdocs-page-utilities></awsdocs-page-utilities></div><div id="quick-feedback-yes" style="display: none;"><div class="title">Did this page help you? - Yes</div><div class="content"><p>Thanks for letting us know we're doing a good job!</p><p>If you've got a moment, please tell us what we did right so we can do more of it.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html"></awsui-button></p></div></div><div id="quick-feedback-no" style="display: none;"><div class="title">Did this page help you? - No</div><div class="content"><p>Thanks for letting us know this page needs work. We're sorry we let you down.</p><p>If you've got a moment, please tell us how we can make the documentation better.</p><p><awsui-button id="fblink" rel="noopener noreferrer" target="_blank" text="Feedback" click="linkClick($event)" href="https://docs.aws.amazon.com/forms/aws-doc-feedback?hidden_service_name=CloudFormation&amp;topic_url=https://docs.aws.amazon.com/en_us/AWSCloudFormation/latest/UserGuide/stacksets-prereqs-self-managed.html"></awsui-button></p></div></div></div></body></div></awsdocs-view><div class="page-loading-indicator" id="page-loading-indicator"><awsui-spinner size="large"></awsui-spinner></div></div><div id="tools-panel" dom-region="tools"><awsdocs-tools-panel id="awsdocs-tools-panel"></awsdocs-tools-panel></div></awsui-app-layout><awsdocs-cookie-banner class="doc-cookie-banner"></awsdocs-cookie-banner></div></body></html>